<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MKT AP - 마케팅 캘린더</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .title {
            font-size: 28px;
            font-weight: bold;
            color: #2563eb;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #f3f4f6;
            border-radius: 20px;
            font-size: 13px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-connected {
            background: #10b981;
        }

        .status-disconnected {
            background: #ef4444;
        }

        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .month-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .nav-btn {
            padding: 8px;
            border: none;
            background: #f3f4f6;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .nav-btn:hover {
            background: #e5e7eb;
        }

        .month-title {
            font-size: 20px;
            font-weight: 600;
        }

        .calendar-info {
            font-size: 14px;
            color: #6b7280;
        }

        .main-content {
            display: flex;
            gap: 24px;
        }

        .settings-panel {
            width: 320px;
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .settings-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .admin-section {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .admin-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
        }

        .admin-info {
            font-size: 13px;
            color: #92400e;
            margin-bottom: 12px;
        }

        .calendar-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .calendar-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .calendar-item:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .calendar-checkbox {
            margin-top: 2px;
        }

        .calendar-details {
            flex: 1;
            min-width: 0;
        }

        .calendar-name {
            font-weight: 500;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .calendar-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .calendar-description {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 2px;
        }

        .calendar-id {
            font-size: 11px;
            color: #9ca3af;
            font-family: monospace;
        }

        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
        }

        .calendar-grid {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .weekday {
            padding: 16px;
            text-align: center;
            font-weight: 600;
            color: #475569;
            border-right: 1px solid #e2e8f0;
        }

        .weekday:last-child {
            border-right: none;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .day-cell {
            min-height: 120px;
            max-width: 100%;
            width: 100%;
            padding: 8px;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            background: white;
            position: relative;
            overflow: hidden;
        }

        .day-cell:last-child {
            border-right: none;
        }

        .day-cell.other-month {
            background: #f8fafc;
            color: #94a3b8;
        }

        .day-cell.today {
            background: #eff6ff;
        }

        .day-number {
            font-weight: 500;
            margin-bottom: 6px;
        }

        .day-number.today {
            color: #2563eb;
            font-weight: 700;
        }

        .events {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .event {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            color: white;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .event:hover {
            opacity: 0.8;
        }

        .event-more {
            font-size: 10px;
            color: #6b7280;
            text-align: center;
            margin-top: 2px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            margin-top: 24px;
            color: #6b7280;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .settings-panel {
                width: 100%;
            }
            
            .header-top {
                flex-direction: column;
                gap: 16px;
            }
            
            .controls {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <h1 class="title">MKT AP</h1>
                <div class="controls">
                    <!-- 연결 상태 표시 -->
                    <div class="status-indicator">
                        <div class="status-dot" id="statusDot"></div>
                        <span id="statusText">구글 미연동</span>
                    </div>

                    <!-- 편집자 로그인 -->
                    <button class="btn btn-primary" id="adminLoginBtn" onclick="adminLogin()">
                        편집자 로그인
                    </button>

                    <!-- 동기화 버튼 -->
                    <button class="btn btn-success" id="syncBtn" onclick="syncCalendars()">
                        <span id="syncIcon">🔄</span>
                        <span id="syncText">동기화</span>
                    </button>

                    <!-- 로그아웃 버튼 -->
                    <button class="btn btn-danger hidden" id="logoutBtn" onclick="adminLogout()">
                        편집자 로그아웃
                    </button>

                    <!-- 설정 토글 -->
                    <button class="btn btn-secondary" onclick="toggleSettings()">
                        ⚙️ 설정
                    </button>
                </div>
            </div>

            <!-- 월 네비게이션 -->
            <div class="month-nav">
                <div class="month-controls">
                    <button class="nav-btn" onclick="changeMonth(-1)">‹</button>
                    <h2 class="month-title" id="monthTitle">2025년 6월</h2>
                    <button class="nav-btn" onclick="changeMonth(1)">›</button>
                </div>
                <div class="calendar-info" id="calendarInfo">
                    편집자가 설정한 캘린더를 확인하세요
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- 설정 패널 -->
            <div class="settings-panel hidden" id="settingsPanel">
                <h3 class="settings-title">캘린더 설정</h3>
                
                <!-- 편집자 섹션 -->
                <div class="admin-section">
                    <div class="admin-title">📋 편집자 전용</div>
                    <div class="admin-info">편집자 계정: pmktb2c@gmail.com</div>
                    <button class="btn btn-primary btn-small" id="adminLoginBtn2" onclick="adminLogin()">
                        편집자로 로그인
                    </button>
                </div>

                <!-- 캘린더 목록 -->
                <div id="calendarSection">
                    <div class="calendar-controls">
                        <span style="font-weight: 500;">구글 캘린더 목록</span>
                        <div class="control-buttons">
                            <button class="btn btn-primary btn-small" onclick="selectAllCalendars(true)">전체선택</button>
                            <button class="btn btn-secondary btn-small" onclick="selectAllCalendars(false)">전체해제</button>
                        </div>
                    </div>
                    
                    <div class="calendar-list" id="calendarList">
                        <div class="loading" id="loadingCalendars">
                            <div class="spinner"></div>
                            로그인 후 캘린더를 확인하세요
                        </div>
                    </div>
                </div>
            </div>

            <!-- 메인 캘린더 -->
            <div class="calendar-grid">
                <!-- 요일 헤더 -->
                <div class="weekdays">
                    <div class="weekday">일</div>
                    <div class="weekday">월</div>
                    <div class="weekday">화</div>
                    <div class="weekday">수</div>
                    <div class="weekday">목</div>
                    <div class="weekday">금</div>
                    <div class="weekday">토</div>
                </div>

                <!-- 날짜 그리드 -->
                <div class="days-grid" id="daysGrid">
                    <!-- 동적으로 생성됨 -->
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>편집자가 공개 설정한 구글 캘린더 일정을 확인할 수 있습니다.</p>
        </div>
    </div>

    <script>
        // 전역 변수
        let currentDate = new Date();
        let isAdminLoggedIn = false;
        let googleCalendars = [];
        let selectedCalendars = new Set();
        let calendarEvents = {};
        let isSettingsVisible = false;
        let publicCalendarIds = [];
        let publicCalendarSettings = [];

        // Google API 설정 - 클라이언트 ID만 사용
        const GOOGLE_CONFIG = {
            clientId: '936288018291-3rrn8jj7ceabs5ho2q1hesrcb17vetj6.apps.googleusercontent.com',
            discoveryDoc: 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
            scopes: 'https://www.googleapis.com/auth/calendar.readonly'
        };

        const ADMIN_EMAIL = 'pmktb2c@gmail.com';

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initializeGoogleAPI();
            updateMonthTitle();
            updateCalendarDisplay();
            loadPublicCalendars();
        });

        // Google API 초기화
        async function initializeGoogleAPI() {
            if (GOOGLE_CONFIG.clientId === '936288018291-3rrn8jj7ceabs5ho2q1hesrcb17vetj6.apps.googleusercontent.com') {
                console.warn('Google 클라이언트 ID가 설정되지 않았습니다.');
                updateLoginStatus();
                return;
            }

            try {
                await new Promise((resolve) => {
                    gapi.load('client:auth2', resolve);
                });

                await gapi.client.init({
                    clientId: GOOGLE_CONFIG.clientId,
                    discoveryDocs: [GOOGLE_CONFIG.discoveryDoc],
                    scope: GOOGLE_CONFIG.scopes
                });

                console.log('Google API 초기화 완료');
                
                // 자동 로그인 확인
                const authInstance = gapi.auth2.getAuthInstance();
                if (authInstance.isSignedIn.get()) {
                    const user = authInstance.currentUser.get();
                    const profile = user.getBasicProfile();
                    if (profile.getEmail() === ADMIN_EMAIL) {
                        isAdminLoggedIn = true;
                        updateLoginStatus();
                        await loadGoogleCalendars();
                    }
                }

                updateLoginStatus();
                
                if (!isAdminLoggedIn) {
                    await loadPublicCalendars();
                }

            } catch (error) {
                console.error('Google API 초기화 실패:', error);
                alert('Google API 초기화에 실패했습니다. 클라이언트 ID를 확인해주세요.');
                updateLoginStatus();
            }
        }

        // 편집자 로그인
        async function adminLogin() {
            if (GOOGLE_CONFIG.clientId === 'YOUR_GOOGLE_CLIENT_ID_HERE') {
                alert('Google 클라이언트 ID를 설정해주세요.');
                return;
            }

            try {
                const authInstance = gapi.auth2.getAuthInstance();
                const user = await authInstance.signIn();
                const profile = user.getBasicProfile();
                
                if (profile.getEmail() === ADMIN_EMAIL) {
                    isAdminLoggedIn = true;
                    updateLoginStatus();
                    await loadGoogleCalendars();
                    updateCalendarInfo();
                    console.log('편집자 로그인 완료');
                } else {
                    alert('편집자 계정(pmktb2c@gmail.com)으로만 로그인 가능합니다.');
                    authInstance.signOut();
                }
            } catch (error) {
                console.error('로그인 실패:', error);
                alert('로그인에 실패했습니다.');
            }
        }

        // 편집자 로그아웃
        async function adminLogout() {
            try {
                const authInstance = gapi.auth2.getAuthInstance();
                await authInstance.signOut();
                isAdminLoggedIn = false;
                googleCalendars = [];
                selectedCalendars.clear();
                calendarEvents = {};
                updateLoginStatus();
                updateCalendarDisplay();
                updateCalendarInfo();
                
                setTimeout(async () => {
                    await loadPublicCalendars();
                }, 500);
                
                console.log('편집자 로그아웃 완료');
            } catch (error) {
                console.error('로그아웃 실패:', error);
            }
        }

        // 로그인 상태 업데이트
        function updateLoginStatus() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const adminLoginBtn = document.getElementById('adminLoginBtn');
            const adminLoginBtn2 = document.getElementById('adminLoginBtn2');
            const logoutBtn = document.getElementById('logoutBtn');
            const syncBtn = document.getElementById('syncBtn');
            const syncText = document.getElementById('syncText');

            if (isAdminLoggedIn) {
                statusDot.className = 'status-dot status-connected';
                statusText.textContent = '편집자 연동됨';
                adminLoginBtn.classList.add('hidden');
                if (adminLoginBtn2) adminLoginBtn2.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                syncBtn.disabled = false;
                if (syncText) syncText.textContent = '동기화';
            } else {
                statusDot.className = 'status-dot status-connected';
                statusText.textContent = '공개 캘린더 보기';
                adminLoginBtn.classList.remove('hidden');
                if (adminLoginBtn2) adminLoginBtn2.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                syncBtn.disabled = false;
                if (syncText) syncText.textContent = '새로고침';
            }
        }

        // 구글 캘린더 목록 로드
        async function loadGoogleCalendars() {
            const calendarListEl = document.getElementById('calendarList');
            calendarListEl.innerHTML = '<div class="loading"><div class="spinner"></div>캘린더 목록 로딩 중...</div>';

            try {
                const response = await gapi.client.calendar.calendarList.list();
                googleCalendars = response.result.items || [];
                
                renderCalendarList();
                
                const primaryCalendar = googleCalendars.find(cal => cal.id === 'primary');
                if (primaryCalendar) {
                    selectedCalendars.add('primary');
                    await loadEventsFromGoogle();
                }

            } catch (error) {
                console.error('캘린더 목록 로드 실패:', error);
                calendarListEl.innerHTML = '<div style="text-align: center; color: #ef4444;">캘린더 목록 로드에 실패했습니다.</div>';
            }
        }

        // 캘린더 목록 렌더링
        function renderCalendarList() {
            const calendarListEl = document.getElementById('calendarList');
            
            if (googleCalendars.length === 0) {
                calendarListEl.innerHTML = '<div style="text-align: center; color: #6b7280;">캘린더가 없습니다.</div>';
                return;
            }

            calendarListEl.innerHTML = googleCalendars.map(calendar => `
                <div class="calendar-item">
                    <input type="checkbox" 
                           class="calendar-checkbox" 
                           id="cal-${calendar.id}"
                           ${selectedCalendars.has(calendar.id) ? 'checked' : ''}
                           onchange="toggleCalendar('${calendar.id}')">
                    <div class="calendar-details">
                        <div class="calendar-name">
                            <div class="calendar-color" style="background-color: ${calendar.backgroundColor || '#4285f4'}"></div>
                            ${calendar.summary}
                        </div>
                        ${calendar.description ? `<div class="calendar-description">${calendar.description}</div>` : ''}
                        <div class="calendar-id">${calendar.id}</div>
                    </div>
                </div>
            `).join('');
        }

        // 캘린더 선택/해제
        function toggleCalendar(calendarId) {
            if (selectedCalendars.has(calendarId)) {
                selectedCalendars.delete(calendarId);
            } else {
                selectedCalendars.add(calendarId);
            }
            updateCalendarInfo();
            
            if (isAdminLoggedIn) {
                savePublicCalendarSettings();
                loadEventsFromGoogle();
            }
        }

        // 전체 선택/해제
        function selectAllCalendars(selectAll) {
            if (selectAll) {
                googleCalendars.forEach(cal => selectedCalendars.add(cal.id));
            } else {
                selectedCalendars.clear();
            }
            
            renderCalendarList();
            updateCalendarInfo();
            
            if (isAdminLoggedIn) {
                savePublicCalendarSettings();
                loadEventsFromGoogle();
            }
        }

        // 공개 캘린더 설정 저장 (편집자 전용)
        function savePublicCalendarSettings() {
            const publicSettings = {
                calendarIds: Array.from(selectedCalendars),
                calendarData: googleCalendars.filter(cal => selectedCalendars.has(cal.id)).map(cal => ({
                    id: cal.id,
                    summary: cal.summary,
                    description: cal.description,
                    backgroundColor: cal.backgroundColor || '#4285f4'
                }))
            };
            
            localStorage.setItem('publicCalendarSettings', JSON.stringify(publicSettings));
            publicCalendarIds = publicSettings.calendarIds;
            publicCalendarSettings = publicSettings.calendarData;
            
            console.log('공개 캘린더 설정 저장됨:', publicSettings);
        }

        // 구글 캘린더에서 이벤트 로드 (편집자 전용)
        async function loadEventsFromGoogle() {
            if (selectedCalendars.size === 0) {
                calendarEvents = {};
                updateCalendarDisplay();
                return;
            }

            try {
                const startTime = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).toISOString();
                const endTime = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0, 23, 59, 59).toISOString();
                
                calendarEvents = {};

                for (const calendarId of selectedCalendars) {
                    const calendar = googleCalendars.find(cal => cal.id === calendarId);
                    if (!calendar) continue;

                    const response = await gapi.client.calendar.events.list({
                        calendarId: calendarId,
                        timeMin: startTime,
                        timeMax: endTime,
                        singleEvents: true,
                        orderBy: 'startTime'
                    });

                    const events = response.result.items || [];
                    events.forEach(event => {
                        const eventDate = event.start.date || event.start.dateTime.split('T')[0];
                        if (!calendarEvents[eventDate]) {
                            calendarEvents[eventDate] = [];
                        }
                        calendarEvents[eventDate].push({
                            id: event.id,
                            title: event.summary || '(제목 없음)',
                            calendar: calendarId,
                            color: calendar.backgroundColor || '#4285f4',
                            description: event.description || ''
                        });
                    });
                }

                updateCalendarDisplay();

            } catch (error) {
                console.error('이벤트 로드 실패:', error);
            }
        }

        // 공개 캘린더 로드 (일반 사용자용)
        async function loadPublicCalendars() {
            console.log('공개 캘린더 로드 시작...');
            
            const savedSettings = localStorage.getItem('publicCalendarSettings');
            
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    publicCalendarIds = settings.calendarIds || [];
                    publicCalendarSettings = settings.calendarData || [];
                    
                    console.log('저장된 공개 캘린더 설정:', settings);
                    
                    if (publicCalendarIds.length > 0) {
                        if (typeof gapi !== 'undefined' && gapi.client && gapi.client.calendar) {
                            await loadPublicEvents(publicCalendarIds);
                        } else {
                            console.log('Google API가 아직 준비되지 않음. 잠시 후 재시도...');
                            setTimeout(async () => {
                                if (typeof gapi !== 'undefined' && gapi.client && gapi.client.calendar) {
                                    await loadPublicEvents(publicCalendarIds);
                                }
                            }, 2000);
                        }
                        
                        updateCalendarInfo();
                        
                        if (!isAdminLoggedIn) {
                            renderPublicCalendarList();
                        }
                    } else {
                        console.log('공개 캘린더 ID가 없습니다.');
                        updateCalendarInfo();
                    }
                } catch (error) {
                    console.error('공개 캘린더 설정 파싱 오류:', error);
                    updateCalendarInfo();
                }
            } else {
                console.log('저장된 공개 캘린더 설정이 없습니다.');
                
                if (!isAdminLoggedIn) {
                    const calendarListEl = document.getElementById('calendarList');
                    if (calendarListEl) {
                        calendarListEl.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #6b7280;">
                                <div style="margin-bottom: 12px;">📝</div>
                                <div style="font-weight: 500; margin-bottom: 8px;">아직 공개된 캘린더가 없습니다</div>
                                <div style="font-size: 13px;">편집자가 캘린더를 설정하면 여기에 표시됩니다</div>
                            </div>
                        `;
                    }
                }
                updateCalendarInfo();
            }
        }

        // 공개 이벤트 로드
        async function loadPublicEvents(calendarIds) {
            if (!calendarIds || calendarIds.length === 0) return;

            try {
                const startTime = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).toISOString();
                const endTime = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0, 23, 59, 59).toISOString();
                
                calendarEvents = {};

                for (const calendarId of calendarIds) {
                    try {
                        const response = await gapi.client.calendar.events.list({
                            calendarId: calendarId,
                            timeMin: startTime,
                            timeMax: endTime,
                            singleEvents: true,
                            orderBy: 'startTime'
                        });

                        const events = response.result.items || [];
                        const calendarInfo = publicCalendarSettings.find(cal => cal.id === calendarId);
                        const calendarColor = calendarInfo ? calendarInfo.backgroundColor : '#10b981';
                        
                        events.forEach(event => {
                            const eventDate = event.start.date || event.start.dateTime.split('T')[0];
                            if (!calendarEvents[eventDate]) {
                                calendarEvents[eventDate] = [];
                            }
                            calendarEvents[eventDate].push({
                                id: event.id,
                                title: event.summary || '(제목 없음)',
                                calendar: calendarId,
                                color: calendarColor,
                                description: event.description || ''
                            });
                        });
                        
                        console.log(`캘린더 ${calendarId}에서 ${events.length}개 이벤트 로드됨`);
                    } catch (error) {
                        console.log(`캘린더 ${calendarId} 로드 실패 (비공개이거나 접근 권한 없음):`, error);
                    }
                }

                updateCalendarDisplay();
                console.log('공개 캘린더 이벤트 로드 완료');

            } catch (error) {
                console.error('공개 이벤트 로드 실패:', error);
            }
        }

        // 공개 캘린더 목록 렌더링 (비로그인 상태)
        function renderPublicCalendarList() {
            const calendarListEl = document.getElementById('calendarList');
            
            if (!calendarListEl) {
                console.error('calendarList 요소를 찾을 수 없습니다.');
                return;
            }
            
            if (publicCalendarSettings.length === 0) {
                calendarListEl.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #6b7280;">
                        <div style="margin-bottom: 12px;">📝</div>
                        <div style="font-weight: 500; margin-bottom: 8px;">아직 공개된 캘린더가 없습니다</div>
                        <div style="font-size: 13px;">편집자가 캘린더를 설정하면 여기에 표시됩니다</div>
                    </div>
                `;
                return;
            }

            console.log('공개 캘린더 목록 렌더링:', publicCalendarSettings);

            calendarListEl.innerHTML = `
                <div style="margin-bottom: 12px; padding: 8px; background: #f0f9ff; border-radius: 6px; font-size: 13px; color: #0369a1;">
                    📖 편집자가 공개한 캘린더 목록 (${publicCalendarSettings.length}개)
                </div>
                ${publicCalendarSettings.map(calendar => `
                    <div class="calendar-item" style="opacity: 0.9;">
                        <div style="width: 16px; height: 16px; background: #10b981; border-radius: 50%; margin-top: 2px;"></div>
                        <div class="calendar-details">
                            <div class="calendar-name">
                                <div class="calendar-color" style="background-color: ${calendar.backgroundColor}"></div>
                                ${calendar.summary}
                            </div>
                            ${calendar.description ? `<div class="calendar-description">${calendar.description}</div>` : ''}
                            <div class="calendar-id">${calendar.id}</div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // 캘린더 동기화
        async function syncCalendars() {
            const syncIcon = document.getElementById('syncIcon');
            const syncBtn = document.getElementById('syncBtn');
            
            syncIcon.style.animation = 'spin 1s linear infinite';
            syncBtn.disabled = true;

            try {
                if (isAdminLoggedIn) {
                    await loadEventsFromGoogle();
                } else {
                    await loadPublicCalendars();
                }
                
                setTimeout(() => {
                    syncIcon.style.animation = '';
                    syncBtn.disabled = false;
                    alert('동기화가 완료되었습니다!');
                }, 1000);

            } catch (error) {
                console.error('동기화 실패:', error);
                syncIcon.style.animation = '';
                syncBtn.disabled = false;
                alert('동기화에 실패했습니다.');
            }
        }

        // 설정 패널 토글
        function toggleSettings() {
            const settingsPanel = document.getElementById('settingsPanel');
            isSettingsVisible = !isSettingsVisible;
            
            if (isSettingsVisible) {
                settingsPanel.classList.remove('hidden');
            } else {
                settingsPanel.classList.add('hidden');
            }
        }

        // 월 변경
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            updateMonthTitle();
            
            if (isAdminLoggedIn) {
                loadEventsFromGoogle();
            } else {
                loadPublicCalendars();
            }
            
            updateCalendarDisplay();
        }

        // 월 제목 업데이트
        function updateMonthTitle() {
            const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
            document.getElementById('monthTitle').textContent = 
                `${currentDate.getFullYear()}년 ${monthNames[currentDate.getMonth()]}`;
        }

        // 캘린더 정보 업데이트
        function updateCalendarInfo() {
            const calendarInfo = document.getElementById('calendarInfo');
            
            if (isAdminLoggedIn) {
                calendarInfo.textContent = `${selectedCalendars.size}개 캘린더 연동 중`;
            } else {
                const publicCount = publicCalendarIds.length;
                if (publicCount > 0) {
                    calendarInfo.textContent = `${publicCount}개 공개 캘린더 표시 중`;
                } else {
                    calendarInfo.textContent = '편집자가 캘린더를 설정하면 여기에 표시됩니다';
                }
            }
        }

        // 캘린더 화면 업데이트
        function updateCalendarDisplay() {
            const daysGrid = document.getElementById('daysGrid');
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // 월의 첫날과 마지막날
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();
            
            // 이전 달의 날짜들
            const prevMonth = new Date(year, month, 0);
            const prevMonthDays = prevMonth.getDate();
            
            let daysHTML = '';
            
            // 이전 달 날짜들
            for (let i = startingDay - 1; i >= 0; i--) {
                const day = prevMonthDays - i;
                const date = new Date(year, month - 1, day);
                const dateStr = date.toISOString().split('T')[0];
                const events = calendarEvents[dateStr] || [];
                
                daysHTML += `
                    <div class="day-cell other-month">
                        <div class="day-number">${day}</div>
                        <div class="events">
                            ${events.slice(0, 3).map(event => 
                                `<div class="event" style="background-color: ${event.color}" title="${event.title}">${event.title}</div>`
                            ).join('')}
                            ${events.length > 3 ? `<div class="event-more">+${events.length - 3}개</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // 현재 달 날짜들
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const events = calendarEvents[dateStr] || [];
                const isToday = date.toDateString() === new Date().toDateString();
                
                daysHTML += `
                    <div class="day-cell ${isToday ? 'today' : ''}">
                        <div class="day-number ${isToday ? 'today' : ''}">${day}</div>
                        <div class="events">
                            ${events.slice(0, 3).map(event => 
                                `<div class="event" style="background-color: ${event.color}" title="${event.title}">${event.title}</div>`
                            ).join('')}
                            ${events.length > 3 ? `<div class="event-more">+${events.length - 3}개</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // 다음 달 날짜들
            const totalCells = 42; // 6주 * 7일
            const remainingCells = totalCells - (startingDay + daysInMonth);
            for (let day = 1; day <= remainingCells; day++) {
                const date = new Date(year, month + 1, day);
                const dateStr = date.toISOString().split('T')[0];
                const events = calendarEvents[dateStr] || [];
                
                daysHTML += `
                    <div class="day-cell other-month">
                        <div class="day-number">${day}</div>
                        <div class="events">
                            ${events.slice(0, 3).map(event => 
                                `<div class="event" style="background-color: ${event.color}" title="${event.title}">${event.title}</div>`
                            ).join('')}
                            ${events.length > 3 ? `<div class="event-more">+${events.length - 3}개</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            daysGrid.innerHTML = daysHTML;
        }

        // 페이지 로드 시 실행
        window.addEventListener('load', function() {
            console.log('페이지 로드 완료');
            updateLoginStatus();
            updateCalendarInfo();
            
            setTimeout(() => {
                if (!isAdminLoggedIn && publicCalendarIds.length === 0) {
                    console.log('공개 캘린더 재로드 시도...');
                    loadPublicCalendars();
                }
            }, 2000);
        });
    </script>
</body>
</html>
