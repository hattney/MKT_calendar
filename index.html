import React, { useState, useEffect } from 'react';
import { Calendar, Settings, RefreshCw, ChevronLeft, ChevronRight, Plus, X, Eye, EyeOff, User, LogIn, LogOut, Lock, Users } from 'lucide-react';

const MarketingCalendar = () => {
  const [currentDate, setCurrentDate] = useState(new Date(2025, 5, 1));
  const [showSettings, setShowSettings] = useState(false);
  const [isGoogleAuthenticated, setIsGoogleAuthenticated] = useState(false);
  const [isEditor, setIsEditor] = useState(false);
  const [googleCalendars, setGoogleCalendars] = useState([]);
  const [selectedCalendars, setSelectedCalendars] = useState(new Set());
  const [events, setEvents] = useState({});
  const [isLoading, setIsLoading] = useState(false);
  const [isLoadingCalendars, setIsLoadingCalendars] = useState(false);
  const [sharedCalendarConfig, setSharedCalendarConfig] = useState(null);

  // Google OAuth Configuration (편집자가 입력할 부분)
  const GOOGLE_CONFIG = {
    clientId: '936288018291-3rrn8jj7ceabs5ho2q1hesrcb17vetj6.apps.googleusercontent.com',
    discoveryDoc: 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
    scopes: 'https://www.googleapis.com/auth/calendar'
  };

  const monthNames = [
    '1월', '2월', '3월', '4월', '5월', '6월',
    '7월', '8월', '9월', '10월', '11월', '12월'
  ];

  const weekDays = ['일', '월', '화', '수', '목', '금', '토'];

  // 편집자가 설정한 공유 캘린더 데이터 (실제로는 서버에서 가져올 데이터)
  const defaultSharedConfig = {
    title: '마컴팀 마케팅 액션 플랜',
    selectedCalendars: ['primary', 'holidays@group.calendar.google.com', 'marketing@company.com'],
    calendars: [
      {
        id: 'primary',
        summary: '마케팅 주요 일정',
        description: '팀 주요 마케팅 활동',
        backgroundColor: '#FF6B6B',
        selected: true
      },
      {
        id: 'marketing@company.com',
        summary: '마케팅팀 캠페인',
        description: '마케팅 캠페인 및 프로젝트',
        backgroundColor: '#4ECDC4',
        selected: true
      },
      {
        id: 'holidays@group.calendar.google.com',
        summary: '대한민국 공휴일',
        description: '국가 공휴일 및 기념일',
        backgroundColor: '#96CEB4',
        selected: true
      },
      {
        id: 'events@company.com',
        summary: '회사 이벤트',
        description: '전사 행사 및 이벤트',
        backgroundColor: '#FFEAA7',
        selected: false
      },
      {
        id: 'work@company.com',
        summary: '업무 일정',
        description: '일반 업무 관련 일정',
        backgroundColor: '#45B7D1',
        selected: false
      }
    ]
  };

  // Sample data for demo (편집자가 설정한 일정들을 모든 사용자가 볼 수 있음)
  const sampleEvents = {
    '2025-06-01': [
      { id: '1', title: '6월 마케팅 전략 회의', calendar: 'primary', color: '#FF6B6B' },
      { id: '2', title: '신제품 런칭 기획', calendar: 'marketing@company.com', color: '#4ECDC4' }
    ],
    '2025-06-03': [
      { id: '3', title: 'SNS 콘텐츠 제작', calendar: 'marketing@company.com', color: '#4ECDC4' }
    ],
    '2025-06-06': [
      { id: '4', title: '현충일', calendar: 'holidays@group.calendar.google.com', color: '#96CEB4' }
    ],
    '2025-06-10': [
      { id: '5', title: '브랜드 캠페인 런칭', calendar: 'primary', color: '#FF6B6B' },
      { id: '6', title: '광고 성과 분석 미팅', calendar: 'marketing@company.com', color: '#4ECDC4' }
    ],
    '2025-06-15': [
      { id: '7', title: '6.25전쟁일', calendar: 'holidays@group.calendar.google.com', color: '#96CEB4' },
      { id: '8', title: '하반기 마케팅 전략 수립', calendar: 'primary', color: '#FF6B6B' }
    ],
    '2025-06-20': [
      { id: '9', title: '고객 피드백 분석', calendar: 'marketing@company.com', color: '#4ECDC4' }
    ],
    '2025-06-25': [
      { id: '10', title: '월말 성과 리뷰', calendar: 'primary', color: '#FF6B6B' }
    ]
  };

  // 컴포넌트 초기화 시 공유 설정 로드
  useEffect(() => {
    loadSharedConfiguration();
  }, []);

  // 공유 캘린더 설정 로드 (편집자가 미리 설정한 내용)
  const loadSharedConfiguration = () => {
    // 실제로는 서버 API에서 가져올 데이터
    setSharedCalendarConfig(defaultSharedConfig);
    setGoogleCalendars(defaultSharedConfig.calendars);
    setSelectedCalendars(new Set(defaultSharedConfig.selectedCalendars));
    setEvents(sampleEvents);
  };

  // Google API 초기화 (편집자만 사용)
  const initializeGoogleAPI = async () => {
    try {
      console.log('Google API 초기화 중...');
      
      setTimeout(() => {
        setIsGoogleAuthenticated(true);
        setIsEditor(true);
        loadGoogleCalendars();
      }, 1000);
      
    } catch (error) {
      console.error('Google API 초기화 실패:', error);
    }
  };

  // 구글 캘린더 목록 불러오기 (편집자용)
  const loadGoogleCalendars = async () => {
    setIsLoadingCalendars(true);
    
    try {
      setTimeout(() => {
        const allCalendars = [
          ...defaultSharedConfig.calendars,
          {
            id: 'personal@gmail.com',
            summary: '개인 일정',
            description: '사적인 약속 및 일정',
            backgroundColor: '#DDA0DD',
            selected: false
          },
          {
            id: 'team-planning@company.com',
            summary: '팀 기획',
            description: '팀 기획 및 브레인스토밍',
            backgroundColor: '#FFB347',
            selected: false
          }
        ];
        
        setGoogleCalendars(allCalendars);
        setIsLoadingCalendars(false);
      }, 1500);
      
    } catch (error) {
      console.error('캘린더 목록 로드 실패:', error);
      setIsLoadingCalendars(false);
    }
  };

  // 구글 로그인 (편집자 인증)
  const signInGoogle = async () => {
    try {
      await initializeGoogleAPI();
    } catch (error) {
      console.error('Google 로그인 실패:', error);
    }
  };

  // 구글 로그아웃
  const signOutGoogle = async () => {
    try {
      setIsGoogleAuthenticated(false);
      setIsEditor(false);
      // 공유 설정으로 되돌리기
      loadSharedConfiguration();
    } catch (error) {
      console.error('Google 로그아웃 실패:', error);
    }
  };

  // 선택된 캘린더들의 이벤트 불러오기 (편집자용)
  const loadEventsFromGoogle = async () => {
    setIsLoading(true);
    
    try {
      setTimeout(() => {
        setEvents(sampleEvents);
        setIsLoading(false);
      }, 1000);
      
    } catch (error) {
      console.error('이벤트 로드 실패:', error);
      setIsLoading(false);
    }
  };

  // 캘린더 선택/해제 (편집자만 가능)
  const toggleCalendarSelection = (calendarId) => {
    if (!isEditor) return;
    
    const newSelected = new Set(selectedCalendars);
    if (newSelected.has(calendarId)) {
      newSelected.delete(calendarId);
    } else {
      newSelected.add(calendarId);
    }
    setSelectedCalendars(newSelected);
  };

  // 모든 캘린더 선택/해제 (편집자만 가능)
  const toggleAllCalendars = (selectAll) => {
    if (!isEditor) return;
    
    if (selectAll) {
      setSelectedCalendars(new Set(googleCalendars.map(cal => cal.id)));
    } else {
      setSelectedCalendars(new Set());
    }
  };

  // 공유 설정 저장 (편집자용)
  const saveSharedConfiguration = () => {
    if (!isEditor) return;
    
    const newConfig = {
      title: '마컴팀 마케팅 액션 플랜',
      selectedCalendars: Array.from(selectedCalendars),
      calendars: googleCalendars.filter(cal => selectedCalendars.has(cal.id))
    };
    
    // 실제로는 서버에 저장
    setSharedCalendarConfig(newConfig);
    alert('공유 설정이 저장되었습니다. 이제 모든 사용자가 이 설정을 볼 수 있습니다.');
  };

  // 월 이동시 이벤트 다시 로드
  useEffect(() => {
    if (isEditor && isGoogleAuthenticated && selectedCalendars.size > 0) {
      loadEventsFromGoogle();
    }
  }, [currentDate, selectedCalendars, isGoogleAuthenticated, isEditor]);

  const getDaysInMonth = (date) => {
    const year = date.getFullYear();
    const month = date.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDay = firstDay.getDay();

    const days = [];
    
    for (let i = startingDay - 1; i >= 0; i--) {
      const prevDate = new Date(year, month, -i);
      days.push({ date: prevDate, isCurrentMonth: false });
    }

    for (let day = 1; day <= daysInMonth; day++) {
      const currentDay = new Date(year, month, day);
      days.push({ date: currentDay, isCurrentMonth: true });
    }

    const remainingDays = 42 - days.length;
    for (let day = 1; day <= remainingDays; day++) {
      const nextDate = new Date(year, month + 1, day);
      days.push({ date: nextDate, isCurrentMonth: false });
    }

    return days;
  };

  const getEventsForDate = (date) => {
    const dateStr = date.toISOString().split('T')[0];
    return events[dateStr] || [];
  };

  const navigateMonth = (direction) => {
    setCurrentDate(prev => {
      const newDate = new Date(prev);
      newDate.setMonth(prev.getMonth() + direction);
      return newDate;
    });
  };

  const days = getDaysInMonth(currentDate);
  const displayCalendars = sharedCalendarConfig ? sharedCalendarConfig.calendars : googleCalendars;
  const displaySelectedCalendars = sharedCalendarConfig ? new Set(sharedCalendarConfig.selectedCalendars) : selectedCalendars;

  return (
    <div className="min-h-screen bg-gray-50 p-4">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="bg-white rounded-lg p-6 mb-6 shadow-sm">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-bold text-gray-800">마컴팀 마케팅 액션 플랜</h1>
              <p className="text-sm text-gray-600 mt-1">
                {isEditor ? '편집자 모드 - 캘린더 설정을 변경할 수 있습니다' : '공유된 마케팅 일정을 확인하세요'}
              </p>
            </div>
            <div className="flex items-center gap-3">
              {/* 사용자 권한 표시 */}
              <div className="flex items-center gap-2 px-3 py-1 rounded-full bg-gray-100">
                {isEditor ? <Settings className="w-4 h-4" /> : <Users className="w-4 h-4" />}
                <span className="text-sm">
                  {isEditor ? '편집자' : '조회자'}
                </span>
                <div className={`w-2 h-2 rounded-full ${isEditor ? 'bg-blue-500' : 'bg-green-500'}`}></div>
              </div>

              {/* Google 인증 상태 (편집자용) */}
              {isEditor && (
                <div className="flex items-center gap-2 px-3 py-1 rounded-full bg-gray-100">
                  <User className="w-4 h-4" />
                  <span className="text-sm">
                    {isGoogleAuthenticated ? '구글 연동됨' : '구글 미연동'}
                  </span>
                  <div className={`w-2 h-2 rounded-full ${isGoogleAuthenticated ? 'bg-green-500' : 'bg-red-500'}`}></div>
                </div>
              )}

              {/* 편집자 전용 버튼들 */}
              {!isEditor ? (
                <button
                  onClick={signInGoogle}
                  className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                >
                  <Lock className="w-4 h-4" />
                  편집자 로그인
                </button>
              ) : (
                <>
                  {isGoogleAuthenticated && (
                    <>
                      <button
                        onClick={loadEventsFromGoogle}
                        disabled={isLoading}
                        className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50"
                      >
                        <RefreshCw className={`w-4 h-4 ${isLoading ? 'animate-spin' : ''}`} />
                        동기화
                      </button>
                      <button
                        onClick={saveSharedConfiguration}
                        className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                      >
                        <Plus className="w-4 h-4" />
                        설정 저장
                      </button>
                    </>
                  )}
                  <button
                    onClick={signOutGoogle}
                    className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                  >
                    <LogOut className="w-4 h-4" />
                    로그아웃
                  </button>
                </>
              )}
              
              <button
                onClick={() => setShowSettings(!showSettings)}
                className="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
              >
                <Settings className="w-4 h-4" />
                {isEditor ? '설정' : '캘린더 목록'}
              </button>
            </div>
          </div>

          {/* Month Navigation */}
          <div className="flex items-center justify-between mt-6">
            <div className="flex items-center gap-4">
              <button
                onClick={() => navigateMonth(-1)}
                className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
              >
                <ChevronLeft className="w-5 h-5" />
              </button>
              <h2 className="text-xl font-semibold">
                {currentDate.getFullYear()}년 {monthNames[currentDate.getMonth()]}
              </h2>
              <button
                onClick={() => navigateMonth(1)}
                className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
              >
                <ChevronRight className="w-5 h-5" />
              </button>
            </div>
            
            <div className="text-sm text-gray-600">
              {displaySelectedCalendars.size}개 캘린더 표시 중
            </div>
          </div>
        </div>

        <div className="flex gap-6">
          {/* Calendar Settings Panel */}
          {showSettings && (
            <div className="w-80 bg-white rounded-lg p-6 shadow-sm">
              <h3 className="text-lg font-semibold mb-4">
                {isEditor ? '캘린더 설정 (편집 가능)' : '표시 중인 캘린더'}
              </h3>
              
              {/* 조회자용 캘린더 목록 */}
              {!isEditor && (
                <div className="space-y-2">
                  <p className="text-sm text-gray-600 mb-4">편집자가 설정한 캘린더 목록입니다.</p>
                  {displayCalendars.map(calendar => (
                    <div key={calendar.id} className="flex items-start gap-3 p-3 border border-gray-200 rounded-lg bg-gray-50">
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-1">
                          <div 
                            className="w-3 h-3 rounded-full flex-shrink-0"
                            style={{ backgroundColor: calendar.backgroundColor }}
                          ></div>
                          <span className="font-medium text-sm truncate">{calendar.summary}</span>
                        </div>
                        {calendar.description && (
                          <p className="text-xs text-gray-500 truncate">{calendar.description}</p>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {/* 편집자용 설정 패널 */}
              {isEditor && (
                <>
                  {!isGoogleAuthenticated ? (
                    <div className="text-center py-8">
                      <div className="text-gray-500 mb-4">구글 캘린더 연동이 필요합니다</div>
                      <button
                        onClick={signInGoogle}
                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                      >
                        구글 로그인
                      </button>
                    </div>
                  ) : (
                    <>
                      {/* Calendar Selection Controls */}
                      <div className="flex justify-between items-center mb-4">
                        <span className="font-medium">구글 캘린더 목록</span>
                        <div className="flex gap-2">
                          <button
                            onClick={() => toggleAllCalendars(true)}
                            className="text-xs px-2 py-1 bg-blue-100 text-blue-600 rounded hover:bg-blue-200 transition-colors"
                          >
                            전체선택
                          </button>
                          <button
                            onClick={() => toggleAllCalendars(false)}
                            className="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition-colors"
                          >
                            전체해제
                          </button>
                        </div>
                      </div>

                      {/* Google Calendars List */}
                      {isLoadingCalendars ? (
                        <div className="text-center py-4">
                          <div className="animate-spin w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full mx-auto mb-2"></div>
                          <div className="text-sm text-gray-500">캘린더 목록 로딩 중...</div>
                        </div>
                      ) : (
                        <div className="space-y-2 max-h-96 overflow-y-auto">
                          {googleCalendars.map(calendar => (
                            <div key={calendar.id} className="flex items-start gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                              <input
                                type="checkbox"
                                checked={selectedCalendars.has(calendar.id)}
                                onChange={() => toggleCalendarSelection(calendar.id)}
                                className="mt-1 w-4 h-4 text-blue-600 rounded focus:ring-blue-500"
                              />
                              <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 mb-1">
                                  <div 
                                    className="w-3 h-3 rounded-full flex-shrink-0"
                                    style={{ backgroundColor: calendar.backgroundColor }}
                                  ></div>
                                  <span className="font-medium text-sm truncate">{calendar.summary}</span>
                                </div>
                                {calendar.description && (
                                  <p className="text-xs text-gray-500 truncate">{calendar.description}</p>
                                )}
                                <p className="text-xs text-gray-400 font-mono truncate">{calendar.id}</p>
                              </div>
                            </div>
                          ))}
                        </div>
                      )}

                      {/* Sync and Save Buttons */}
                      <div className="mt-4 pt-4 border-t space-y-2">
                        <button
                          onClick={loadEventsFromGoogle}
                          disabled={isLoading || selectedCalendars.size === 0}
                          className="w-full flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50"
                        >
                          <RefreshCw className={`w-4 h-4 ${isLoading ? 'animate-spin' : ''}`} />
                          선택된 캘린더 동기화
                        </button>
                        <button
                          onClick={saveSharedConfiguration}
                          disabled={selectedCalendars.size === 0}
                          className="w-full flex items-center justify-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50"
                        >
                          <Plus className="w-4 h-4" />
                          공유 설정으로 저장
                        </button>
                      </div>
                    </>
                  )}
                </>
              )}
            </div>
          )}

          {/* Main Calendar */}
          <div className="flex-1 bg-white rounded-lg shadow-sm overflow-hidden">
            {/* Week Headers */}
            <div className="grid grid-cols-7 bg-gray-50 border-b">
              {weekDays.map(day => (
                <div key={day} className="p-4 text-center font-semibold text-gray-700 border-r last:border-r-0">
                  {day}
                </div>
              ))}
            </div>

            {/* Calendar Grid */}
            <div className="grid grid-cols-7">
              {days.map((day, index) => {
                const dayEvents = getEventsForDate(day.date);
                const isToday = day.date.toDateString() === new Date().toDateString();
                
                return (
                  <div 
                    key={index} 
                    className={`min-h-32 p-2 border-r border-b last:border-r-0 ${
                      !day.isCurrentMonth ? 'bg-gray-50 text-gray-400' : 'bg-white'
                    } ${isToday ? 'bg-blue-50' : ''}`}
                  >
                    <div className={`text-sm font-medium mb-2 ${
                      isToday ? 'text-blue-600' : day.isCurrentMonth ? 'text-gray-900' : 'text-gray-400'
                    }`}>
                      {day.date.getDate()}
                    </div>
                    
                    {/* Events */}
                    <div className="space-y-1">
                      {dayEvents.slice(0, 3).map((event, eventIndex) => (
                        <div
                          key={eventIndex}
                          className="text-xs p-1 rounded truncate text-white cursor-pointer hover:opacity-80"
                          style={{ backgroundColor: event.color }}
                          title={`${event.title}`}
                        >
                          {event.title}
                        </div>
                      ))}
                      {dayEvents.length > 3 && (
                        <div className="text-xs text-gray-500 text-center">
                          +{dayEvents.length - 3}개
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>

        {/* Footer Info */}
        <div className="mt-6 text-center text-gray-500 text-sm">
          <p>
            {isEditor ? 
              '편집자로 로그인하여 캘린더 설정을 변경하고 모든 사용자와 공유할 수 있습니다.' :
              '편집자가 설정한 마케팅 일정을 실시간으로 확인할 수 있습니다.'
            }
          </p>
        </div>
      </div>
    </div>
  );
};

export default MarketingCalendar;
