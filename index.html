<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MKT AP - 마케팅 캘린더</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .title {
            font-size: 28px;
            font-weight: bold;
            color: #2563eb;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #f3f4f6;
            border-radius: 20px;
            font-size: 13px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-connected {
            background: #10b981;
        }

        .status-disconnected {
            background: #ef4444;
        }

        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .month-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .nav-btn {
            padding: 8px;
            border: none;
            background: #f3f4f6;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .nav-btn:hover {
            background: #e5e7eb;
        }

        .month-title {
            font-size: 20px;
            font-weight: 600;
        }

        .calendar-info {
            font-size: 14px;
            color: #6b7280;
        }

        .main-content {
            display: flex;
            gap: 24px;
        }

        .settings-panel {
            width: 320px;
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .settings-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .admin-section {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .admin-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
        }

        .admin-info {
            font-size: 13px;
            color: #92400e;
            margin-bottom: 12px;
        }

        .calendar-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .calendar-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .calendar-item:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .calendar-checkbox {
            margin-top: 2px;
        }

        .calendar-details {
            flex: 1;
            min-width: 0;
        }

        .calendar-name {
            font-weight: 500;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .calendar-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .calendar-description {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 2px;
        }

        .calendar-id {
            font-size: 11px;
            color: #9ca3af;
            font-family: monospace;
        }

        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
        }

        .calendar-grid {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .weekday {
            padding: 16px;
            text-align: center;
            font-weight: 600;
            color: #475569;
            border-right: 1px solid #e2e8f0;
            width: 100%;
            box-sizing: border-box;
        }

        .weekday:last-child {
            border-right: none;
        }

        .weekday.sunday {
            color: #ef4444;
            font-weight: 700;
        }

        .weekday.saturday {
            color: #3b82f6;
            font-weight: 700;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-auto-rows: minmax(120px, auto);
        }

        .day-cell {
            min-height: 120px;
            max-height: 180px;
            padding: 8px;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            background: white;
            position: relative;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .day-cell:last-child {
            border-right: none;
        }

        .day-cell.other-month {
            background: #f8fafc;
            color: #94a3b8;
        }

        .day-cell.today {
            background: #fef3c7;
            border: 2px solid #f59e0b;
        }

        .day-cell.sunday {
            background: #fef2f2;
        }

        .day-cell.saturday {
            background: #eff6ff;
        }

        .day-number.sunday {
            color: #ef4444;
            font-weight: 700;
        }

        .day-number.saturday {
            color: #3b82f6;
            font-weight: 700;
        }

        .day-number {
            font-weight: 500;
            margin-bottom: 6px;
        }

        .day-number.today {
            color: #2563eb;
            font-weight: 700;
        }

        .events {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .event {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            color: white;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .event:hover {
            opacity: 0.8;
        }

        .event-more {
            font-size: 10px;
            color: #6b7280;
            text-align: center;
            margin-top: 2px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            margin-top: 24px;
            color: #6b7280;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .settings-panel {
                width: 100%;
            }
            
            .header-top {
                flex-direction: column;
                gap: 16px;
            }
            
            .controls {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <h1 class="title">MKT AP</h1>
                <div class="controls">
                    <!-- 연결 상태 표시 -->
                    <div class="status-indicator">
                        <div class="status-dot" id="statusDot"></div>
                        <span id="statusText">Google API 로딩 중...</span>
                    </div>

                    <!-- 편집자 로그인 -->
                    <button class="btn btn-primary" id="adminLoginBtn">
                        편집자 로그인
                    </button>

                    <!-- 동기화 버튼 -->
                    <button class="btn btn-success" id="syncBtn">
                        <span id="syncIcon">🔄</span>
                        <span id="syncText">동기화</span>
                    </button>

                    <!-- 로그아웃 버튼 -->
                    <button class="btn btn-danger hidden" id="logoutBtn">
                        편집자 로그아웃
                    </button>

                    <!-- 설정 토글 -->
                    <button class="btn btn-secondary" id="settingsToggleBtn">
                        ⚙️ 설정
                    </button>
                </div>
            </div>

            <!-- 월 네비게이션 -->
            <div class="month-nav">
                <div class="month-controls">
                    <button class="nav-btn" id="prevMonthBtn">‹</button>
                    <h2 class="month-title" id="monthTitle">2025년 6월</h2>
                    <button class="nav-btn" id="nextMonthBtn">›</button>
                </div>
                <div class="calendar-info" id="calendarInfo">
                    편집자가 설정한 캘린더를 확인하세요
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- 설정 패널 -->
            <div class="settings-panel hidden" id="settingsPanel">
                <h3 class="settings-title">캘린더 설정</h3>
                
                <!-- API 키 안내 -->
                <div class="error-message" id="apiKeyWarning" style="display: none;">
                    Google API 키를 설정해주세요. 코드의 GOOGLE_CONFIG 부분에 실제 API 키와 클라이언트 ID를 입력하세요.
                </div>
                
                <!-- 편집자 섹션 -->
                <div class="admin-section">
                    <div class="admin-title">📋 편집자 전용</div>
                    <div class="admin-info">편집자 계정: pmktb2c@gmail.com</div>
                    <button class="btn btn-primary btn-small" id="adminLoginBtn2">
                        편집자로 로그인
                    </button>
                </div>

                <!-- 캘린더 목록 -->
                <div id="calendarSection">
                    <div class="calendar-controls">
                        <span style="font-weight: 500;">구글 캘린더 목록</span>
                        <div class="control-buttons">
                            <button class="btn btn-primary btn-small" id="selectAllBtn">전체선택</button>
                            <button class="btn btn-secondary btn-small" id="deselectAllBtn">전체해제</button>
                        </div>
                    </div>
                    
                    <div class="calendar-list" id="calendarList">
                        <div class="loading" id="loadingCalendars">
                            <div class="spinner"></div>
                            로그인 후 캘린더를 확인하세요
                        </div>
                    </div>
                </div>
            </div>

            <!-- 메인 캘린더 -->
            <div class="calendar-grid">
                <!-- 요일 헤더 -->
                <div class="weekdays">
                    <div class="weekday sunday">일</div>
                    <div class="weekday">월</div>
                    <div class="weekday">화</div>
                    <div class="weekday">수</div>
                    <div class="weekday">목</div>
                    <div class="weekday">금</div>
                    <div class="weekday saturday">토</div>
                </div>

                <!-- 날짜 그리드 -->
                <div class="days-grid" id="daysGrid">
                    <!-- 동적으로 생성됨 -->
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>편집자가 공개 설정한 구글 캘린더 일정을 확인할 수 있습니다.</p>
        </div>
    </div>

    <script>
        // 전역 변수
        let currentDate = new Date();
        let isAdminLoggedIn = false;
        let googleCalendars = [];
        let selectedCalendars = new Set();
        let calendarEvents = {};
        let isSettingsVisible = false;
        let publicCalendarIds = [];
        let publicCalendarSettings = [];
        let isApiReady = false;

        // Google API 설정 - 실제 키로 교체해주세요
        const GOOGLE_CONFIG = {
            apiKey: 'YOUR_GOOGLE_API_KEY_HERE',
            clientId: 'Y936288018291-3rrn8jj7ceabs5ho2q1hesrcb17vetj6.apps.googleusercontent.com',
            discoveryDoc: 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
            scopes: 'https://www.googleapis.com/auth/calendar.readonly'
        };

        const ADMIN_EMAIL = 'pmktb2c@gmail.com';

        // DOM 요소들을 안전하게 가져오는 함수
        function getElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element with id '${id}' not found`);
            }
            return element;
        }

        // 이벤트 리스너 등록 함수
        function attachEventListeners() {
            const adminLoginBtn = getElement('adminLoginBtn');
            const adminLoginBtn2 = getElement('adminLoginBtn2');
            const logoutBtn = getElement('logoutBtn');
            const syncBtn = getElement('syncBtn');
            const settingsToggleBtn = getElement('settingsToggleBtn');
            const prevMonthBtn = getElement('prevMonthBtn');
            const nextMonthBtn = getElement('nextMonthBtn');
            const selectAllBtn = getElement('selectAllBtn');
            const deselectAllBtn = getElement('deselectAllBtn');

            // 편집자 로그인 버튼들
            if (adminLoginBtn) {
                adminLoginBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('편집자 로그인 버튼 클릭');
                    adminLogin();
                });
            }

            if (adminLoginBtn2) {
                adminLoginBtn2.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('편집자 로그인 버튼2 클릭');
                    adminLogin();
                });
            }

            // 로그아웃 버튼
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('로그아웃 버튼 클릭');
                    adminLogout();
                });
            }

            // 동기화 버튼
            if (syncBtn) {
                syncBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('동기화 버튼 클릭');
                    syncCalendars();
                });
            }

            // 설정 토글 버튼
            if (settingsToggleBtn) {
                settingsToggleBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('설정 토글 버튼 클릭');
                    toggleSettings();
                });
            }

            // 월 네비게이션 버튼들
            if (prevMonthBtn) {
                prevMonthBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('이전 월 버튼 클릭');
                    changeMonth(-1);
                });
            }

            if (nextMonthBtn) {
                nextMonthBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('다음 월 버튼 클릭');
                    changeMonth(1);
                });
            }

            // 전체 선택/해제 버튼들
            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('전체 선택 버튼 클릭');
                    selectAllCalendars(true);
                });
            }

            if (deselectAllBtn) {
                deselectAllBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('전체 해제 버튼 클릭');
                    selectAllCalendars(false);
                });
            }
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM 로드 완료, 초기화 시작');
            
            // 이벤트 리스너 먼저 등록
            attachEventListeners();
            
            // UI 업데이트
            updateMonthTitle();
            updateCalendarDisplay();
            updateLoginStatus();
            updateCalendarInfo();
            
            // Google API 초기화
            initializeGoogleAPI();
            
            // 공개 캘린더 로드 (지연)
            setTimeout(loadPublicCalendars, 1000);
        });

        // Google API 초기화
        async function initializeGoogleAPI() {
            console.log('Google API 초기화 시작...');
            
            const statusText = getElement('statusText');
            
            // API 키 확인
            if (GOOGLE_CONFIG.apiKey === 'YOUR_GOOGLE_API_KEY_HERE' || 
                GOOGLE_CONFIG.clientId === 'YOUR_GOOGLE_CLIENT_ID_HERE') {
                console.warn('Google API 키가 설정되지 않았습니다.');
                if (statusText) statusText.textContent = 'API 키 미설정';
                
                const apiKeyWarning = getElement('apiKeyWarning');
                if (apiKeyWarning) apiKeyWarning.style.display = 'block';
                
                updateLoginStatus();
                await loadPublicCalendars();
                return;
            }

            try {
                if (typeof gapi === 'undefined') {
                    console.error('Google API 스크립트가 로드되지 않았습니다.');
                    if (statusText) statusText.textContent = 'API 로딩 실패';
                    return;
                }

                await new Promise((resolve, reject) => {
                    gapi.load('client:auth2', {
                        callback: resolve,
                        onerror: reject
                    });
                });

                await gapi.client.init({
                    apiKey: GOOGLE_CONFIG.apiKey,
                    clientId: GOOGLE_CONFIG.clientId,
                    discoveryDocs: [GOOGLE_CONFIG.discoveryDoc],
                    scope: GOOGLE_CONFIG.scopes
                });

                console.log('Google API 초기화 완료');
                isApiReady = true;
                
                const authInstance = gapi.auth2.getAuthInstance();
                if (authInstance && authInstance.isSignedIn.get()) {
                    const user = authInstance.currentUser.get();
                    const profile = user.getBasicProfile();
                    if (profile.getEmail() === ADMIN_EMAIL) {
                        isAdminLoggedIn = true;
                        await loadGoogleCalendars();
                    }
                }

                updateLoginStatus();
                
                if (!isAdminLoggedIn) {
                    await loadPublicCalendars();
                }

            } catch (error) {
                console.error('Google API 초기화 실패:', error);
                if (statusText) statusText.textContent = 'API 초기화 실패';
                await loadPublicCalendars();
            }
        }

        // 편집자 로그인
        async function adminLogin() {
            console.log('편집자 로그인 시도...');
            
            if (!isApiReady) {
                alert('Google API가 아직 준비되지 않았습니다. 잠시 후 다시 시도해주세요.');
                return;
            }

            try {
                const authInstance = gapi.auth2.getAuthInstance();
                if (!authInstance) {
                    console.error('Google Auth2 인스턴스를 가져올 수 없습니다.');
                    alert('Google 로그인 서비스에 문제가 있습니다. 페이지를 새로고침해주세요.');
                    return;
                }

                console.log('Google 로그인 팝업 표시...');
                const user = await authInstance.signIn();
                const profile = user.getBasicProfile();
                const email = profile.getEmail();
                
                console.log('로그인한 이메일:', email);
                
                if (email === ADMIN_EMAIL) {
                    isAdminLoggedIn = true;
                    updateLoginStatus();
                    await loadGoogleCalendars();
                    updateCalendarInfo();
                    console.log('편집자 로그인 완료');
                    alert('편집자 로그인이 완료되었습니다!');
                } else {
                    alert(`편집자 계정(${ADMIN_EMAIL})으로만 로그인 가능합니다.\n현재 로그인: ${email}`);
                    authInstance.signOut();
                }
            } catch (error) {
                console.error('로그인 실패:', error);
                if (error.error === 'popup_closed_by_user') {
                    alert('로그인이 취소되었습니다.');
                } else if (error.error === 'access_denied') {
                    alert('로그인 권한이 거부되었습니다.');
                } else {
                    alert('로그인에 실패했습니다: ' + (error.details || error.message || '알 수 없는 오류'));
                }
            }
        }

        // 편집자 로그아웃
        async function adminLogout() {
            console.log('편집자 로그아웃 시도...');
            
            try {
                if (isApiReady && gapi && gapi.auth2) {
                    const authInstance = gapi.auth2.getAuthInstance();
                    if (authInstance && authInstance.isSignedIn.get()) {
                        await authInstance.signOut();
                        console.log('Google 계정 로그아웃 완료');
                    }
                }
                
                // 상태 초기화
                isAdminLoggedIn = false;
                googleCalendars = [];
                selectedCalendars.clear();
                calendarEvents = {};
                
                // UI 업데이트
                updateLoginStatus();
                updateCalendarDisplay();
                updateCalendarInfo();
                
                // 공개 캘린더 로드
                setTimeout(async () => {
                    await loadPublicCalendars();
                }, 500);
                
                console.log('편집자 로그아웃 완료');
                alert('로그아웃되었습니다.');
                
            } catch (error) {
                console.error('로그아웃 실패:', error);
                alert('로그아웃 중 오류가 발생했습니다.');
            }
        }

        // 로그인 상태 업데이트
        function updateLoginStatus() {
            const statusDot = getElement('statusDot');
            const statusText = getElement('statusText');
            const adminLoginBtn = getElement('adminLoginBtn');
            const adminLoginBtn2 = getElement('adminLoginBtn2');
            const logoutBtn = getElement('logoutBtn');
            const syncBtn = getElement('syncBtn');
            const syncText = getElement('syncText');

            if (isAdminLoggedIn) {
                if (statusDot) statusDot.className = 'status-dot status-connected';
                if (statusText) statusText.textContent = '편집자 연동됨';
                if (adminLoginBtn) adminLoginBtn.classList.add('hidden');
                if (adminLoginBtn2) adminLoginBtn2.classList.add('hidden');
                if (logoutBtn) logoutBtn.classList.remove('hidden');
                if (syncBtn) syncBtn.disabled = false;
                if (syncText) syncText.textContent = '동기화';
            } else {
                if (statusDot) statusDot.className = 'status-dot status-connected';
                if (statusText) statusText.textContent = '공개 캘린더 보기';
                if (adminLoginBtn) adminLoginBtn.classList.remove('hidden');
                if (adminLoginBtn2) adminLoginBtn2.classList.remove('hidden');
                if (logoutBtn) logoutBtn.classList.add('hidden');
                if (syncBtn) syncBtn.disabled = false;
                if (syncText) syncText.textContent = '새로고침';
            }
        }

        // 동기화 함수
        async function syncCalendars() {
            const syncIcon = getElement('syncIcon');
            const syncBtn = getElement('syncBtn');
            
            if (syncIcon) syncIcon.style.animation = 'spin 1s linear infinite';
            if (syncBtn) syncBtn.disabled = true;

            try {
                if (isAdminLoggedIn) {
                    await loadEventsFromGoogle();
                } else {
                    await loadPublicCalendars();
                }
                
                setTimeout(() => {
                    if (syncIcon) syncIcon.style.animation = '';
                    if (syncBtn) syncBtn.disabled = false;
                    alert('동기화가 완료되었습니다!');
                }, 1000);

            } catch (error) {
                console.error('동기화 실패:', error);
                if (syncIcon) syncIcon.style.animation = '';
                if (syncBtn) syncBtn.disabled = false;
                alert('동기화에 실패했습니다.');
            }
        }

        // 설정 패널 토글
        function toggleSettings() {
            const settingsPanel = getElement('settingsPanel');
            if (!settingsPanel) return;
            
            isSettingsVisible = !isSettingsVisible;
            
            if (isSettingsVisible) {
                settingsPanel.classList.remove('hidden');
            } else {
                settingsPanel.classList.add('hidden');
            }
        }

        // 월 변경
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            updateMonthTitle();
            
            if (isAdminLoggedIn) {
                loadEventsFromGoogle();
            } else {
                loadPublicCalendars();
            }
            
            updateCalendarDisplay();
        }

        // 월 제목 업데이트
        function updateMonthTitle() {
            const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
            const monthTitle = getElement('monthTitle');
            if (monthTitle) {
                monthTitle.textContent = `${currentDate.getFullYear()}년 ${monthNames[currentDate.getMonth()]}`;
            }
        }

        // 캘린더 정보 업데이트
        function updateCalendarInfo() {
            const calendarInfo = getElement('calendarInfo');
            if (!calendarInfo) return;
            
            if (isAdminLoggedIn) {
                calendarInfo.textContent = `${selectedCalendars.size}개 캘린더 연동 중`;
            } else {
                const publicCount = publicCalendarIds.length;
                if (publicCount > 0) {
                    calendarInfo.textContent = `${publicCount}개 공개 캘린더 표시 중`;
                } else {
                    calendarInfo.textContent = '편집자가 캘린더를 설정하면 여기에 표시됩니다';
                }
            }
        }

        // 구글 캘린더 목록 로드
        async function loadGoogleCalendars() {
            const calendarListEl = getElement('calendarList');
            if (calendarListEl) {
                calendarListEl.innerHTML = '<div class="loading"><div class="spinner"></div>캘린더 목록 로딩 중...</div>';
            }

            try {
                const response = await gapi.client.calendar.calendarList.list();
                googleCalendars = response.result.items || [];
                
                renderCalendarList();
                
                const primaryCalendar = googleCalendars.find(cal => cal.id === 'primary');
                if (primaryCalendar) {
                    selectedCalendars.add('primary');
                    await loadEventsFromGoogle();
                }

            } catch (error) {
                console.error('캘린더 목록 로드 실패:', error);
                if (calendarListEl) {
                    calendarListEl.innerHTML = '<div style="text-align: center; color: #ef4444;">캘린더 목록 로드에 실패했습니다.</div>';
                }
            }
        }

        // 캘린더 목록 렌더링
        function renderCalendarList() {
            const calendarListEl = getElement('calendarList');
            if (!calendarListEl) return;
            
            if (googleCalendars.length === 0) {
                calendarListEl.innerHTML = '<div style="text-align: center; color: #6b7280;">캘린더가 없습니다.</div>';
                return;
            }

            calendarListEl.innerHTML = googleCalendars.map(calendar => `
                <div class="calendar-item">
                    <input type="checkbox" 
                           class="calendar-checkbox" 
                           id="cal-${calendar.id}"
                           ${selectedCalendars.has(calendar.id) ? 'checked' : ''}
                           onchange="toggleCalendar('${calendar.id}')">
                    <div class="calendar-details">
                        <div class="calendar-name">
                            <div class="calendar-color" style="background-color: ${calendar.backgroundColor || '#4285f4'}"></div>
                            ${calendar.summary}
                        </div>
                        ${calendar.description ? `<div class="calendar-description">${calendar.description}</div>` : ''}
                        <div class="calendar-id">${calendar.id}</div>
                    </div>
                </div>
            `).join('');
        }

        // 캘린더 선택/해제
        function toggleCalendar(calendarId) {
            if (selectedCalendars.has(calendarId)) {
                selectedCalendars.delete(calendarId);
            } else {
                selectedCalendars.add(calendarId);
            }
            updateCalendarInfo();
            
            if (isAdminLoggedIn) {
                savePublicCalendarSettings();
                loadEventsFromGoogle();
            }
        }

        // 전체 선택/해제
        function selectAllCalendars(selectAll) {
            if (selectAll) {
                googleCalendars.forEach(cal => selectedCalendars.add(cal.id));
            } else {
                selectedCalendars.clear();
            }
            
            renderCalendarList();
            updateCalendarInfo();
            
            if (isAdminLoggedIn) {
                savePublicCalendarSettings();
                loadEventsFromGoogle();
            }
        }

        // 공개 캘린더 설정 저장 (편집자 전용)
        function savePublicCalendarSettings() {
            const publicSettings = {
                calendarIds: Array.from(selectedCalendars),
                calendarData: googleCalendars.filter(cal => selectedCalendars.has(cal.id)).map(cal => ({
                    id: cal.id,
                    summary: cal.summary,
                    description: cal.description,
                    backgroundColor: cal.backgroundColor || '#4285f4'
                }))
            };
            
            localStorage.setItem('publicCalendarSettings', JSON.stringify(publicSettings));
            publicCalendarIds = publicSettings.calendarIds;
            publicCalendarSettings = publicSettings.calendarData;
            
            console.log('공개 캘린더 설정 저장됨:', publicSettings);
        }

        // 구글 캘린더에서 이벤트 로드 (편집자 전용)
        async function loadEventsFromGoogle() {
            if (selectedCalendars.size === 0) {
                calendarEvents = {};
                updateCalendarDisplay();
                return;
            }

            try {
                const startTime = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).toISOString();
                const endTime = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0, 23, 59, 59).toISOString();
                
                calendarEvents = {};

                for (const calendarId of selectedCalendars) {
                    const calendar = googleCalendars.find(cal => cal.id === calendarId);
                    if (!calendar) continue;

                    const response = await gapi.client.calendar.events.list({
                        calendarId: calendarId,
                        timeMin: startTime,
                        timeMax: endTime,
                        singleEvents: true,
                        orderBy: 'startTime'
                    });

                    const events = response.result.items || [];
                    events.forEach(event => {
                        const eventDate = event.start.date || event.start.dateTime.split('T')[0];
                        if (!calendarEvents[eventDate]) {
                            calendarEvents[eventDate] = [];
                        }
                        calendarEvents[eventDate].push({
                            id: event.id,
                            title: event.summary || '(제목 없음)',
                            calendar: calendarId,
                            color: calendar.backgroundColor || '#4285f4',
                            description: event.description || ''
                        });
                    });
                }

                updateCalendarDisplay();

            } catch (error) {
                console.error('이벤트 로드 실패:', error);
            }
        }

        // 공개 캘린더 로드 (일반 사용자용)
        async function loadPublicCalendars() {
            console.log('공개 캘린더 로드 시작...');
            
            const savedSettings = localStorage.getItem('publicCalendarSettings');
            
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    publicCalendarIds = settings.calendarIds || [];
                    publicCalendarSettings = settings.calendarData || [];
                    
                    console.log('저장된 공개 캘린더 설정:', settings);
                    
                    if (publicCalendarIds.length > 0 && isApiReady) {
                        await loadPublicEvents(publicCalendarIds);
                        updateCalendarInfo();
                        
                        if (!isAdminLoggedIn) {
                            renderPublicCalendarList();
                        }
                    } else {
                        console.log('공개 캘린더 ID가 없거나 API가 준비되지 않음');
                        updateCalendarInfo();
                    }
                } catch (error) {
                    console.error('공개 캘린더 설정 파싱 오류:', error);
                    updateCalendarInfo();
                }
            } else {
                console.log('저장된 공개 캘린더 설정이 없습니다.');
                
                if (!isAdminLoggedIn) {
                    const calendarListEl = getElement('calendarList');
                    if (calendarListEl) {
                        calendarListEl.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #6b7280;">
                                <div style="margin-bottom: 12px;">📝</div>
                                <div style="font-weight: 500; margin-bottom: 8px;">아직 공개된 캘린더가 없습니다</div>
                                <div style="font-size: 13px;">편집자가 캘린더를 설정하면 여기에 표시됩니다</div>
                            </div>
                        `;
                    }
                }
                updateCalendarInfo();
            }
        }

        // 공개 이벤트 로드
        async function loadPublicEvents(calendarIds) {
            if (!calendarIds || calendarIds.length === 0 || !isApiReady) return;

            try {
                const startTime = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).toISOString();
                const endTime = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0, 23, 59, 59).toISOString();
                
                calendarEvents = {};

                for (const calendarId of calendarIds) {
                    try {
                        const response = await gapi.client.calendar.events.list({
                            calendarId: calendarId,
                            timeMin: startTime,
                            timeMax: endTime,
                            singleEvents: true,
                            orderBy: 'startTime'
                        });

                        const events = response.result.items || [];
                        const calendarInfo = publicCalendarSettings.find(cal => cal.id === calendarId);
                        const calendarColor = calendarInfo ? calendarInfo.backgroundColor : '#10b981';
                        
                        events.forEach(event => {
                            const eventDate = event.start.date || event.start.dateTime.split('T')[0];
                            if (!calendarEvents[eventDate]) {
                                calendarEvents[eventDate] = [];
                            }
                            calendarEvents[eventDate].push({
                                id: event.id,
                                title: event.summary || '(제목 없음)',
                                calendar: calendarId,
                                color: calendarColor,
                                description: event.description || ''
                            });
                        });
                        
                        console.log(`캘린더 ${calendarId}에서 ${events.length}개 이벤트 로드됨`);
                    } catch (error) {
                        console.log(`캘린더 ${calendarId} 로드 실패 (비공개이거나 접근 권한 없음):`, error);
                    }
                }

                updateCalendarDisplay();
                console.log('공개 캘린더 이벤트 로드 완료');

            } catch (error) {
                console.error('공개 이벤트 로드 실패:', error);
            }
        }

        // 공개 캘린더 목록 렌더링 (비로그인 상태)
        function renderPublicCalendarList() {
            const calendarListEl = getElement('calendarList');
            if (!calendarListEl) {
                console.error('calendarList 요소를 찾을 수 없습니다.');
                return;
            }
            
            if (publicCalendarSettings.length === 0) {
                calendarListEl.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #6b7280;">
                        <div style="margin-bottom: 12px;">📝</div>
                        <div style="font-weight: 500; margin-bottom: 8px;">아직 공개된 캘린더가 없습니다</div>
                        <div style="font-size: 13px;">편집자가 캘린더를 설정하면 여기에 표시됩니다</div>
                    </div>
                `;
                return;
            }

            console.log('공개 캘린더 목록 렌더링:', publicCalendarSettings);

            calendarListEl.innerHTML = `
                <div style="margin-bottom: 12px; padding: 8px; background: #f0f9ff; border-radius: 6px; font-size: 13px; color: #0369a1;">
                    📖 편집자가 공개한 캘린더 목록 (${publicCalendarSettings.length}개)
                </div>
                ${publicCalendarSettings.map(calendar => `
                    <div class="calendar-item" style="opacity: 0.9;">
                        <div style="width: 16px; height: 16px; background: #10b981; border-radius: 50%; margin-top: 2px;"></div>
                        <div class="calendar-details">
                            <div class="calendar-name">
                                <div class="calendar-color" style="background-color: ${calendar.backgroundColor}"></div>
                                ${calendar.summary}
                            </div>
                            ${calendar.description ? `<div class="calendar-description">${calendar.description}</div>` : ''}
                            <div class="calendar-id">${calendar.id}</div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // 캘린더 화면 업데이트
        function updateCalendarDisplay() {
            const daysGrid = getElement('daysGrid');
            if (!daysGrid) return;
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();
            
            const prevMonth = new Date(year, month, 0);
            const prevMonthDays = prevMonth.getDate();
            
            let daysHTML = '';
            
            // 이전 달 날짜들
            for (let i = startingDay - 1; i >= 0; i--) {
                const day = prevMonthDays - i;
                const date = new Date(year, month - 1, day);
                const dateStr = date.toISOString().split('T')[0];
                const events = calendarEvents[dateStr] || [];
                const dayOfWeek = date.getDay();
                
                let dayClasses = 'day-cell other-month';
                let dayNumberClasses = 'day-number';
                
                if (dayOfWeek === 0) {
                    dayClasses += ' sunday';
                    dayNumberClasses += ' sunday';
                } else if (dayOfWeek === 6) {
                    dayClasses += ' saturday';
                    dayNumberClasses += ' saturday';
                }
                
                daysHTML += `
                    <div class="${dayClasses}">
                        <div class="${dayNumberClasses}">${day}</div>
                        <div class="events">
                            ${events.slice(0, 3).map(event => 
                                `<div class="event" style="background-color: ${event.color}" title="${event.title}">${event.title}</div>`
                            ).join('')}
                            ${events.length > 3 ? `<div class="event-more">+${events.length - 3}개</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // 현재 달 날짜들
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const events = calendarEvents[dateStr] || [];
                const isToday = date.toDateString() === new Date().toDateString();
                const dayOfWeek = date.getDay();
                
                let dayClasses = 'day-cell';
                let dayNumberClasses = 'day-number';
                
                if (isToday) {
                    dayClasses += ' today';
                    dayNumberClasses += ' today';
                }
                
                if (dayOfWeek === 0) {
                    dayClasses += ' sunday';
                    dayNumberClasses += ' sunday';
                } else if (dayOfWeek === 6) {
                    dayClasses += ' saturday';
                    dayNumberClasses += ' saturday';
                }
                
                daysHTML += `
                    <div class="${dayClasses}">
                        <div class="${dayNumberClasses}">${day}</div>
                        <div class="events">
                            ${events.slice(0, 3).map(event => 
                                `<div class="event" style="background-color: ${event.color}" title="${event.title}">${event.title}</div>`
                            ).join('')}
                            ${events.length > 3 ? `<div class="event-more">+${events.length - 3}개</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // 다음 달 날짜들
            const totalCells = 42;
            const remainingCells = totalCells - (startingDay + daysInMonth);
            for (let day = 1; day <= remainingCells; day++) {
                const date = new Date(year, month + 1, day);
                const dateStr = date.toISOString().split('T')[0];
                const events = calendarEvents[dateStr] || [];
                const dayOfWeek = date.getDay();
                
                let dayClasses = 'day-cell other-month';
                let dayNumberClasses = 'day-number';
                
                if (dayOfWeek === 0) {
                    dayClasses += ' sunday';
                    dayNumberClasses += ' sunday';
                } else if (dayOfWeek === 6) {
                    dayClasses += ' saturday';
                    dayNumberClasses += ' saturday';
                }
                
                daysHTML += `
                    <div class="${dayClasses}">
                        <div class="${dayNumberClasses}">${day}</div>
                        <div class="events">
                            ${events.slice(0, 3).map(event => 
                                `<div class="event" style="background-color: ${event.color}" title="${event.title}">${event.title}</div>`
                            ).join('')}
                            ${events.length > 3 ? `<div class="event-more">+${events.length - 3}개</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            daysGrid.innerHTML = daysHTML;
        }

        // 페이지 로드 시 추가 안전장치
        window.addEventListener('load', function() {
            console.log('Window load 이벤트 발생');
            
            // DOM이 완전히 로드되지 않은 경우 재시도
            if (!document.getElementById('adminLoginBtn')) {
                console.log('DOM 요소들이 아직 준비되지 않음, 재시도...');
                setTimeout(() => {
                    attachEventListeners();
                    updateLoginStatus();
                    updateCalendarInfo();
                }, 500);
            }
            
            // API가 준비된 후 공개 캘린더 로드
            setTimeout(() => {
                if (!isAdminLoggedIn && isApiReady) {
                    console.log('공개 캘린더 재로드 시도...');
                    loadPublicCalendars();
                }
            }, 3000);
        });

        // 전역 함수로 노출 (HTML에서 직접 호출하는 경우를 위해)
        window.adminLogin = adminLogin;
        window.adminLogout = adminLogout;
        window.syncCalendars = syncCalendars;
        window.toggleSettings = toggleSettings;
        window.changeMonth = changeMonth;
        window.selectAllCalendars = selectAllCalendars;
        window.toggleCalendar = toggleCalendar;
    </script>
</body>
</html>
