<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MKT AP - ë§ˆì¼€íŒ… ìº˜ë¦°ë”</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .title {
            font-size: 28px;
            font-weight: bold;
            color: #2563eb;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #f3f4f6;
            border-radius: 20px;
            font-size: 13px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-connected {
            background: #10b981;
        }

        .status-disconnected {
            background: #ef4444;
        }

        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .month-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .nav-btn {
            padding: 8px;
            border: none;
            background: #f3f4f6;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .nav-btn:hover {
            background: #e5e7eb;
        }

        .month-title {
            font-size: 20px;
            font-weight: 600;
        }

        .calendar-info {
            font-size: 14px;
            color: #6b7280;
        }

        .main-content {
            display: flex;
            gap: 24px;
        }

        .settings-panel {
            width: 320px;
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .settings-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .admin-section {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .admin-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
        }

        .admin-info {
            font-size: 13px;
            color: #92400e;
            margin-bottom: 12px;
        }

        .calendar-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .calendar-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .calendar-item:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .calendar-checkbox {
            margin-top: 2px;
        }

        .calendar-details {
            flex: 1;
            min-width: 0;
        }

        .calendar-name {
            font-weight: 500;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .calendar-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .calendar-description {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 2px;
        }

        .calendar-id {
            font-size: 11px;
            color: #9ca3af;
            font-family: monospace;
        }

        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
        }

        .calendar-grid {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .weekday {
            padding: 16px;
            text-align: center;
            font-weight: 600;
            color: #475569;
            border-right: 1px solid #e2e8f0;
        }

        .weekday:last-child {
            border-right: none;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .day-cell {
            min-height: 120px;
            padding: 8px;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            background: white;
            position: relative;
        }

        .day-cell:last-child {
            border-right: none;
        }

        .day-cell.other-month {
            background: #f8fafc;
            color: #94a3b8;
        }

        .day-cell.today {
            background: #eff6ff;
        }

        .day-number {
            font-weight: 500;
            margin-bottom: 6px;
        }

        .day-number.today {
            color: #2563eb;
            font-weight: 700;
        }

        .events {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .event {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            color: white;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .event:hover {
            opacity: 0.8;
        }

        .event-more {
            font-size: 10px;
            color: #6b7280;
            text-align: center;
            margin-top: 2px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            margin-top: 24px;
            color: #6b7280;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .settings-panel {
                width: 100%;
            }
            
            .header-top {
                flex-direction: column;
                gap: 16px;
            }
            
            .controls {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <h1 class="title">MKT AP</h1>
                <div class="controls">
                    <!-- ì—°ê²° ìƒíƒœ í‘œì‹œ -->
                    <div class="status-indicator">
                        <div class="status-dot" id="statusDot"></div>
                        <span id="statusText">êµ¬ê¸€ ë¯¸ì—°ë™</span>
                    </div>

                    <!-- í¸ì§‘ì ë¡œê·¸ì¸ -->
                    <button class="btn btn-primary" id="adminLoginBtn" onclick="adminLogin()">
                        í¸ì§‘ì ë¡œê·¸ì¸
                    </button>

                    <!-- ë™ê¸°í™” ë²„íŠ¼ -->
                    <button class="btn btn-success" id="syncBtn" onclick="syncCalendars()">
                        <span id="syncIcon">ğŸ”„</span>
                        ë™ê¸°í™”
                    </button>

                    <!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
                    <button class="btn btn-danger hidden" id="logoutBtn" onclick="adminLogout()">
                        í¸ì§‘ì ë¡œê·¸ì•„ì›ƒ
                    </button>

                    <!-- ì„¤ì • í† ê¸€ -->
                    <button class="btn btn-secondary" onclick="toggleSettings()">
                        âš™ï¸ ì„¤ì •
                    </button>
                </div>
            </div>

            <!-- ì›” ë„¤ë¹„ê²Œì´ì…˜ -->
            <div class="month-nav">
                <div class="month-controls">
                    <button class="nav-btn" onclick="changeMonth(-1)">â€¹</button>
                    <h2 class="month-title" id="monthTitle">2025ë…„ 6ì›”</h2>
                    <button class="nav-btn" onclick="changeMonth(1)">â€º</button>
                </div>
                <div class="calendar-info" id="calendarInfo">
                    í¸ì§‘ìê°€ ì„¤ì •í•œ ìº˜ë¦°ë”ë¥¼ í™•ì¸í•˜ì„¸ìš”
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- ì„¤ì • íŒ¨ë„ -->
            <div class="settings-panel hidden" id="settingsPanel">
                <h3 class="settings-title">ìº˜ë¦°ë” ì„¤ì •</h3>
                
                <!-- í¸ì§‘ì ì„¹ì…˜ -->
                <div class="admin-section">
                    <div class="admin-title">ğŸ“‹ í¸ì§‘ì ì „ìš©</div>
                    <div class="admin-info">í¸ì§‘ì ê³„ì •: pmktb2c@gmail.com</div>
                    <button class="btn btn-primary btn-small" id="adminLoginBtn2" onclick="adminLogin()">
                        í¸ì§‘ìë¡œ ë¡œê·¸ì¸
                    </button>
                </div>

                <!-- ìº˜ë¦°ë” ëª©ë¡ -->
                <div id="calendarSection">
                    <div class="calendar-controls">
                        <span style="font-weight: 500;">êµ¬ê¸€ ìº˜ë¦°ë” ëª©ë¡</span>
                        <div class="control-buttons">
                            <button class="btn btn-primary btn-small" onclick="selectAllCalendars(true)">ì „ì²´ì„ íƒ</button>
                            <button class="btn btn-secondary btn-small" onclick="selectAllCalendars(false)">ì „ì²´í•´ì œ</button>
                        </div>
                    </div>
                    
                    <div class="calendar-list" id="calendarList">
                        <div class="loading" id="loadingCalendars">
                            <div class="spinner"></div>
                            ë¡œê·¸ì¸ í›„ ìº˜ë¦°ë”ë¥¼ í™•ì¸í•˜ì„¸ìš”
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë©”ì¸ ìº˜ë¦°ë” -->
            <div class="calendar-grid">
                <!-- ìš”ì¼ í—¤ë” -->
                <div class="weekdays">
                    <div class="weekday">ì¼</div>
                    <div class="weekday">ì›”</div>
                    <div class="weekday">í™”</div>
                    <div class="weekday">ìˆ˜</div>
                    <div class="weekday">ëª©</div>
                    <div class="weekday">ê¸ˆ</div>
                    <div class="weekday">í† </div>
                </div>

                <!-- ë‚ ì§œ ê·¸ë¦¬ë“œ -->
                <div class="days-grid" id="daysGrid">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>í¸ì§‘ìê°€ ê³µê°œ ì„¤ì •í•œ êµ¬ê¸€ ìº˜ë¦°ë” ì¼ì •ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentDate = new Date();
        let isAdminLoggedIn = false;
        let googleCalendars = [];
        let selectedCalendars = new Set();
        let calendarEvents = {};
        let isSettingsVisible = false;
        let publicCalendarIds = []; // í¸ì§‘ìê°€ ì„¤ì •í•œ ê³µê°œ ìº˜ë¦°ë” IDë“¤

        // Google API ì„¤ì • - ì‹¤ì œ í‚¤ë¡œ êµì²´í•´ì•¼ í•¨
        const GOOGLE_CONFIG = {
            clientId: '936288018291-3rrn8jj7ceabs5ho2q1hesrcb17vetj6.apps.googleusercontent.com',
            discoveryDoc: 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
            scopes: 'https://www.googleapis.com/auth/calendar.readonly'
        };

        const ADMIN_EMAIL = 'pmktb2c@gmail.com';

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeGoogleAPI();
            updateMonthTitle();
            updateCalendarDisplay();
            loadPublicCalendars();
        });

        // Google API ì´ˆê¸°í™”
        async function initializeGoogleAPI() {
            try {
                await new Promise((resolve) => {
                    gapi.load('client:auth2', resolve);
                });

                await gapi.client.init({
                    apiKey: GOOGLE_CONFIG.apiKey,
                    clientId: GOOGLE_CONFIG.clientId,
                    discoveryDocs: [GOOGLE_CONFIG.discoveryDoc],
                    scope: GOOGLE_CONFIG.scopes
                });

                console.log('Google API ì´ˆê¸°í™” ì™„ë£Œ');
                
                // ìë™ ë¡œê·¸ì¸ í™•ì¸
                const authInstance = gapi.auth2.getAuthInstance();
                if (authInstance.isSignedIn.get()) {
                    const user = authInstance.currentUser.get();
                    const profile = user.getBasicProfile();
                    if (profile.getEmail() === ADMIN_EMAIL) {
                        isAdminLoggedIn = true;
                        updateLoginStatus();
                        await loadGoogleCalendars();
                    }
                }

                updateLoginStatus();

            } catch (error) {
                console.error('Google API ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                updateStatus('ì—°ê²° ì‹¤íŒ¨', false);
            }
        }

        // í¸ì§‘ì ë¡œê·¸ì¸
        async function adminLogin() {
            try {
                const authInstance = gapi.auth2.getAuthInstance();
                const user = await authInstance.signIn();
                const profile = user.getBasicProfile();
                
                if (profile.getEmail() === ADMIN_EMAIL) {
                    isAdminLoggedIn = true;
                    updateLoginStatus();
                    await loadGoogleCalendars();
                    updateCalendarInfo();
                } else {
                    alert('í¸ì§‘ì ê³„ì •(pmktb2c@gmail.com)ìœ¼ë¡œë§Œ ë¡œê·¸ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                    authInstance.signOut();
                }
            } catch (error) {
                console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                alert('ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í¸ì§‘ì ë¡œê·¸ì•„ì›ƒ
        async function adminLogout() {
            try {
                const authInstance = gapi.auth2.getAuthInstance();
                await authInstance.signOut();
                isAdminLoggedIn = false;
                googleCalendars = [];
                selectedCalendars.clear();
                calendarEvents = {};
                updateLoginStatus();
                updateCalendarDisplay();
                updateCalendarInfo();
                document.getElementById('calendarList').innerHTML = '<div class="loading">ë¡œê·¸ì¸ í›„ ìº˜ë¦°ë”ë¥¼ í™•ì¸í•˜ì„¸ìš”</div>';
                
                // ë¡œê·¸ì•„ì›ƒ í›„ ê³µê°œ ìº˜ë¦°ë” ë‹¤ì‹œ ë¡œë“œ
                loadPublicCalendars();
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
            }
        }

        // ë¡œê·¸ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateLoginStatus() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const adminLoginBtn = document.getElementById('adminLoginBtn');
            const adminLoginBtn2 = document.getElementById('adminLoginBtn2');
            const logoutBtn = document.getElementById('logoutBtn');
            const syncBtn = document.getElementById('syncBtn');

            if (isAdminLoggedIn) {
                statusDot.className = 'status-dot status-connected';
                statusText.textContent = 'í¸ì§‘ì ì—°ë™ë¨';
                adminLoginBtn.classList.add('hidden');
                if (adminLoginBtn2) adminLoginBtn2.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                syncBtn.disabled = false;
            } else {
                statusDot.className = 'status-dot status-disconnected';
                statusText.textContent = 'ê³µê°œ ìº˜ë¦°ë” ë³´ê¸°';
                adminLoginBtn.classList.remove('hidden');
                if (adminLoginBtn2) adminLoginBtn2.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                syncBtn.disabled = false;
            }
        }

        // êµ¬ê¸€ ìº˜ë¦°ë” ëª©ë¡ ë¡œë“œ
        async function loadGoogleCalendars() {
            const calendarListEl = document.getElementById('calendarList');
            calendarListEl.innerHTML = '<div class="loading"><div class="spinner"></div>ìº˜ë¦°ë” ëª©ë¡ ë¡œë”© ì¤‘...</div>';

            try {
                const response = await gapi.client.calendar.calendarList.list();
                googleCalendars = response.result.items || [];
                
                renderCalendarList();
                
                // ê¸°ë³¸ì ìœ¼ë¡œ primary ìº˜ë¦°ë” ì„ íƒ
                const primaryCalendar = googleCalendars.find(cal => cal.id === 'primary');
                if (primaryCalendar) {
                    selectedCalendars.add('primary');
                    await loadEventsFromGoogle();
                }

            } catch (error) {
                console.error('ìº˜ë¦°ë” ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                calendarListEl.innerHTML = '<div style="text-align: center; color: #ef4444;">ìº˜ë¦°ë” ëª©ë¡ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ìº˜ë¦°ë” ëª©ë¡ ë Œë”ë§
        function renderCalendarList() {
            const calendarListEl = document.getElementById('calendarList');
            
            if (googleCalendars.length === 0) {
                calendarListEl.innerHTML = '<div style="text-align: center; color: #6b7280;">ìº˜ë¦°ë”ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            calendarListEl.innerHTML = googleCalendars.map(calendar => `
                <div class="calendar-item">
                    <input type="checkbox" 
                           class="calendar-checkbox" 
                           id="cal-${calendar.id}"
                           ${selectedCalendars.has(calendar.id) ? 'checked' : ''}
                           onchange="toggleCalendar('${calendar.id}')">
                    <div class="calendar-details">
                        <div class="calendar-name">
                            <div class="calendar-color" style="background-color: ${calendar.backgroundColor || '#4285f4'}"></div>
                            ${calendar.summary}
                        </div>
                        ${calendar.description ? `<div class="calendar-description">${calendar.description}</div>` : ''}
                        <div class="calendar-id">${calendar.id}</div>
                    </div>
                </div>
            `).join('');
        }

        // ìº˜ë¦°ë” ì„ íƒ/í•´ì œ
        function toggleCalendar(calendarId) {
            if (selectedCalendars.has(calendarId)) {
                selectedCalendars.delete(calendarId);
            } else {
                selectedCalendars.add(calendarId);
            }
            updateCalendarInfo();
            
            // ì„ íƒëœ ìº˜ë¦°ë”ì˜ ê³µê°œ ìƒíƒœ ì €ì¥ (í¸ì§‘ì ì „ìš©)
            if (isAdminLoggedIn) {
                savePublicCalendarSettings();
                loadEventsFromGoogle();
            }
        }

        // ì „ì²´ ì„ íƒ/í•´ì œ
        function selectAllCalendars(selectAll) {
            if (selectAll) {
                googleCalendars.forEach(cal => selectedCalendars.add(cal.id));
            } else {
                selectedCalendars.clear();
            }
            
            renderCalendarList();
            updateCalendarInfo();
            
            if (isAdminLoggedIn) {
                savePublicCalendarSettings();
                loadEventsFromGoogle();
            }
        }

        // ê³µê°œ ìº˜ë¦°ë” ì„¤ì • ì €ì¥ (í¸ì§‘ì ì „ìš©)
        function savePublicCalendarSettings() {
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ê³µê°œ ìº˜ë¦°ë” ì„¤ì • ì €ì¥
            const publicSettings = Array.from(selectedCalendars);
            localStorage.setItem('publicCalendarIds', JSON.stringify(publicSettings));
            publicCalendarIds = publicSettings;
        }

        // êµ¬ê¸€ ìº˜ë¦°ë”ì—ì„œ ì´ë²¤íŠ¸ ë¡œë“œ (í¸ì§‘ì ì „ìš©)
        async function loadEventsFromGoogle() {
            if (selectedCalendars.size === 0) {
                calendarEvents = {};
                updateCalendarDisplay();
                return;
            }

            try {
                const startTime = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).toISOString();
                const endTime = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0, 23, 59, 59).toISOString();
                
                calendarEvents = {};

                for (const calendarId of selectedCalendars) {
                    const calendar = googleCalendars.find(cal => cal.id === calendarId);
                    if (!calendar) continue;

                    const response = await gapi.client.calendar.events.list({
                        calendarId: calendarId,
                        timeMin: startTime,
                        timeMax: endTime,
                        singleEvents: true,
                        orderBy: 'startTime'
                    });

                    const events = response.result.items || [];
                    events.forEach(event => {
                        const eventDate = event.start.date || event.start.dateTime.split('T')[0];
                        if (!calendarEvents[eventDate]) {
                            calendarEvents[eventDate] = [];
                        }
                        calendarEvents[eventDate].push({
                            id: event.id,
                            title: event.summary || '(ì œëª© ì—†ìŒ)',
                            calendar: calendarId,
                            color: calendar.backgroundColor || '#4285f4',
                            description: event.description || ''
                        });
                    });
                }

                updateCalendarDisplay();

            } catch (error) {
                console.error('ì´ë²¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ê³µê°œ ìº˜ë¦°ë” ë¡œë“œ (ì¼ë°˜ ì‚¬ìš©ììš©)
        function loadPublicCalendars() {
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í¸ì§‘ìê°€ ì„¤ì •í•œ ê³µê°œ ìº˜ë¦°ë” ëª©ë¡ ë¡œë“œ
            const savedSettings = localStorage.getItem('publicCalendarIds');
            if (savedSettings) {
                publicCalendarIds = JSON.parse(savedSettings);
                
                if (publicCalendarIds.length > 0 && !isAdminLoggedIn) {
                    loadPublicEvents(publicCalendarIds);
                }
            }
        }

        // ê³µê°œ ì´ë²¤íŠ¸ ë¡œë“œ
        async function loadPublicEvents(calendarIds) {
            if (!calendarIds || calendarIds.length === 0) return;

            try {
                const startTime = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).toISOString();
                const endTime = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0, 23, 59, 59).toISOString();
                
                calendarEvents = {};

                for (const calendarId of calendarIds) {
                    try {
                        const response = await gapi.client.calendar.events.list({
                            calendarId: calendarId,
                            timeMin: startTime,
                            timeMax: endTime,
                            singleEvents: true,
                            orderBy: 'startTime'
                        });

                        const events = response.result.items || [];
                        events.forEach(event => {
                            const eventDate = event.start.date || event.start.dateTime.split('T')[0];
                            if (!calendarEvents[eventDate]) {
                                calendarEvents[eventDate] = [];
                            }
                            calendarEvents[eventDate].push({
                                id: event.id,
                                title: event.summary || '(ì œëª© ì—†ìŒ)',
                                calendar: calendarId,
                                color: '#10b981',
                                description: event.description || ''
                            });
                        });
                    } catch (error) {
                        console.log(`ìº˜ë¦°ë” ${calendarId} ë¡œë“œ ì‹¤íŒ¨:`, error);
                    }
                }

                updateCalendarDisplay();

            } catch (error) {
                console.error('ê³µê°œ ì´ë²¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ìº˜ë¦°ë” ë™ê¸°í™”
        async function syncCalendars() {
            const syncIcon = document.getElementById('syncIcon');
            const syncBtn = document.getElementById('syncBtn');
            
            syncIcon.style.animation = 'spin 1s linear infinite';
            syncBtn.disabled = true;

            try {
                if (isAdminLoggedIn) {
                    await loadEventsFromGoogle();
                } else {
                    loadPublicCalendars();
                }
                
                setTimeout(() => {
                    syncIcon.style.animation = '';
                    syncBtn.disabled = false;
                    alert('ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                }, 1000);

            } catch (error) {
                console.error('ë™ê¸°í™” ì‹¤íŒ¨:', error);
                syncIcon.style.animation = '';
                syncBtn.disabled = false;
                alert('ë™ê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì„¤ì • íŒ¨ë„ í† ê¸€
        function toggleSettings() {
            const settingsPanel = document.getElementById('settingsPanel');
            isSettingsVisible = !isSettingsVisible;
            
            if (isSettingsVisible) {
                settingsPanel.classList.remove('hidden');
            } else {
                settingsPanel.classList.add('hidden');
            }
        }

        // ì›” ë³€ê²½
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            updateMonthTitle();
            
            if (isAdminLoggedIn) {
                loadEventsFromGoogle();
            } else {
                loadPublicCalendars();
            }
            
            updateCalendarDisplay();
        }

        // ì›” ì œëª© ì—…ë°ì´íŠ¸
        function updateMonthTitle() {
            const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
            document.getElementById('monthTitle').textContent = 
                `${currentDate.getFullYear()}ë…„ ${monthNames[currentDate.getMonth()]}`;
        }

        // ìº˜ë¦°ë” ì •ë³´ ì—…ë°ì´íŠ¸
        function updateCalendarInfo() {
            const calendarInfo = document.getElementById('calendarInfo');
            
            if (isAdminLoggedIn) {
                calendarInfo.textContent = `${selectedCalendars.size}ê°œ ìº˜ë¦°ë” ì—°ë™ ì¤‘`;
            } else {
                const publicCount = publicCalendarIds.length;
                calendarInfo.textContent = publicCount > 0 ? 
                    `${publicCount}ê°œ ê³µê°œ ìº˜ë¦°ë” í‘œì‹œ ì¤‘` : 
                    'í¸ì§‘ìê°€ ì„¤ì •í•œ ìº˜ë¦°ë”ë¥¼ í™•ì¸í•˜ì„¸ìš”';
            }
        }

        // ìº˜ë¦°ë” í™”ë©´ ì—…ë°ì´íŠ¸
        function updateCalendarDisplay() {
            const daysGrid = document.getElementById('daysGrid');
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // ì›”ì˜ ì²«ë‚ ê³¼ ë§ˆì§€ë§‰ë‚ 
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();
            
            // ì´ì „ ë‹¬ì˜ ë‚ ì§œë“¤
            const prevMonth = new Date(year, month, 0);
            const prevMonthDays = prevMonth.getDate();
            
            let daysHTML = '';
            
            // ì´ì „ ë‹¬ ë‚ ì§œë“¤
            for (let i = startingDay - 1; i >= 0; i--) {
                const day = prevMonthDays - i;
                const date = new Date(year, month - 1, day);
                const dateStr = date.toISOString().split('T')[0];
                const events = calendarEvents[dateStr] || [];
                
                daysHTML += `
                    <div class="day-cell other-month">
                        <div class="day-number">${day}</div>
                        <div class="events">
                            ${events.slice(0, 3).map(event => 
                                `<div class="event" style="background-color: ${event.color}" title="${event.title}">${event.title}</div>`
                            ).join('')}
                            ${events.length > 3 ? `<div class="event-more">+${events.length - 3}ê°œ</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // í˜„ì¬ ë‹¬ ë‚ ì§œë“¤
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const events = calendarEvents[dateStr] || [];
                const isToday = date.toDateString() === new Date().toDateString();
                
                daysHTML += `
                    <div class="day-cell ${isToday ? 'today' : ''}">
                        <div class="day-number ${isToday ? 'today' : ''}">${day}</div>
                        <div class="events">
                            ${events.slice(0, 3).map(event => 
                                `<div class="event" style="background-color: ${event.color}" title="${event.title}">${event.title}</div>`
                            ).join('')}
                            ${events.length > 3 ? `<div class="event-more">+${events.length - 3}ê°œ</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // ë‹¤ìŒ ë‹¬ ë‚ ì§œë“¤
            const totalCells = 42; // 6ì£¼ * 7ì¼
            const remainingCells = totalCells - (startingDay + daysInMonth);
            for (let day = 1; day <= remainingCells; day++) {
                const date = new Date(year, month + 1, day);
                const dateStr = date.toISOString().split('T')[0];
                const events = calendarEvents[dateStr] || [];
                
                daysHTML += `
                    <div class="day-cell other-month">
                        <div class="day-number">${day}</div>
                        <div class="events">
                            ${events.slice(0, 3).map(event => 
                                `<div class="event" style="background-color: ${event.color}" title="${event.title}">${event.title}</div>`
                            ).join('')}
                            ${events.length > 3 ? `<div class="event-more">+${events.length - 3}ê°œ</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            daysGrid.innerHTML = daysHTML;
        }

        // ì´ë²¤íŠ¸ ìƒì„¸ ì •ë³´ í‘œì‹œ (í´ë¦­ì‹œ)
        function showEventDetails(event) {
            alert(`ì œëª©: ${event.title}\nì„¤ëª…: ${event.description || 'ì„¤ëª… ì—†ìŒ'}\nìº˜ë¦°ë”: ${event.calendar}`);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('load', function() {
            updateLoginStatus();
            updateCalendarInfo();
        });
    </script>
</body>
</html>
